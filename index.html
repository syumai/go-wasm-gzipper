<!DOCTYPE html>
<html>
  <head>
    <title>Go wasm example</title>
  </head>
  <body>
    <form id="fileForm" action="#">
      <input type="file" name="file" />
      <button>Download as gzip</button>
    </form>

    <script src="./wasm_exec.js"></script>
    <script>
      (async () => {
        const go = new Go();
        const { instance } = await WebAssembly.instantiateStreaming(
          fetch('main.wasm'),
          go.importObject
        );
        await go.run(instance);
      })();
    </script>
    <script>
      const fileForm = document.getElementById('fileForm');
      const fileField = fileForm.children.file;
      fileForm.addEventListener('submit', e => {
        e.preventDefault();
        if (fileField.files.length < 1) {
          return;
        }
        const file = fileField.files[0];
        const gzName = `${file.name}.gz`;
        const compressor = new Compressor(gzName, file.size);
        const fr = new FileReader();
        fr.readAsArrayBuffer(file);
        fr.addEventListener('loadend', () => {
          const bytes = new Uint8Array(fr.result);
          for (let i = 0; i < file.size; i++) {
            compressor.buffer[i] = bytes[i];
          }
          const result = compressor.compress();
          const blob = new Blob([result], { type: 'application/gzip' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = gzName;
          a.click();
        });
      });
    </script>
  </body>
</html>
